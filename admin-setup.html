<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>КОНТУР — Настройка администратора</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <header class="top">
    <div class="brand">
      <a class="back" href="index.html">← Архив</a>
      <div class="logo">КОНТУР</div>
      <div class="sub">Настройка администратора</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panel-title">⚠️ ВНИМАНИЕ</div>
      <div class="panel-body">
        <div class="note" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444; margin-bottom: 16px;">
          <strong>Эта страница предназначена только для первоначальной настройки.</strong><br>
          После использования удалите файл <code>admin-setup.html</code> из проекта для безопасности.
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-title">Установка роли администратора</div>
      <div class="panel-body">
        <form id="admin-setup-form">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">Email пользователя</label>
            <input id="user-email" class="input" type="email" placeholder="observer@example.com" required />
            <div class="note" style="margin-top: 8px; font-size: 12px;">
              Введите email пользователя, которому нужно дать права администратора
            </div>
          </div>

          <div id="form-error" class="note" style="display: none; color: #ef4444; margin-bottom: 16px;"></div>
          <div id="form-success" class="note" style="display: none; color: #34d399; margin-bottom: 16px;"></div>

          <button type="submit" class="btn-link" style="width: 100%; background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
            Установить роль администратора
          </button>
        </form>
      </div>
    </section>

    <section class="panel" id="result-section" style="display: none;">
      <div class="panel-title">Результат</div>
      <div class="panel-body">
        <div id="result-content"></div>
      </div>
    </section>
  </main>

  <script src="assets/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      'use strict';
      
      let supabase = null;

      async function init() {
        if (!window.CONTOUR_CONFIG || window.CONTOUR_CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Supabase не настроен. Пожалуйста, настройте assets/config.js
            </div>
          `;
          return;
        }

        if (typeof window.supabase === 'undefined') {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Не удалось загрузить Supabase SDK
            </div>
          `;
          return;
        }

        supabase = window.supabase.createClient(
          window.CONTOUR_CONFIG.SUPABASE_URL,
          window.CONTOUR_CONFIG.SUPABASE_ANON_KEY
        );

        // Проверяем, что пользователь авторизован
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          window.location.href = 'login.html?return=admin-setup.html';
          return;
        }

        // Проверяем, что текущий пользователь уже админ (для безопасности)
        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (!profile || profile.role !== 'admin') {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Только существующий администратор может использовать эту страницу.<br>
              Если у вас еще нет администратора, используйте SQL-скрипт из файла supabase/setup-admin-observer.sql
            </div>
          `;
          return;
        }
      }

      document.getElementById('admin-setup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const errorEl = document.getElementById('form-error');
        const successEl = document.getElementById('form-success');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
        resultSection.style.display = 'none';

        const email = document.getElementById('user-email').value.trim();

        try {
          // Находим пользователя по email
          const { data: users, error: usersError } = await supabase.auth.admin.listUsers();
          
          if (usersError) {
            // Если нет прав admin, используем обычный способ
            const { data: targetUser, error: findError } = await supabase
              .from('auth.users')
              .select('id')
              .eq('email', email)
              .single();

            if (findError) {
              throw new Error('Пользователь с таким email не найден. Убедитесь, что пользователь зарегистрирован.');
            }

            // Обновляем роль через profiles
            const { error: updateError } = await supabase
              .from('profiles')
              .update({ role: 'admin' })
              .eq('id', targetUser.id);

            if (updateError) throw updateError;
          } else {
            // Используем admin API если доступен
            const targetUser = users.users.find(u => u.email === email);
            if (!targetUser) {
              throw new Error('Пользователь с таким email не найден. Убедитесь, что пользователь зарегистрирован.');
            }

            const { error: updateError } = await supabase
              .from('profiles')
              .update({ role: 'admin' })
              .eq('id', targetUser.id);

            if (updateError) throw updateError;
          }

          // Проверяем результат
          const { data: updatedProfile, error: checkError } = await supabase
            .from('profiles')
            .select('username, role, email')
            .eq('email', email)
            .single();

          if (checkError) {
            // Пробуем через join с auth.users
            const { data: profileData } = await supabase
              .from('profiles')
              .select(`
                username,
                role,
                auth.users!inner(email)
              `)
              .eq('auth.users.email', email)
              .single();

            if (profileData) {
              successEl.textContent = `Роль администратора успешно установлена для ${email}`;
              successEl.style.display = 'block';
              
              resultContent.innerHTML = `
                <div class="kv">
                  <div class="kv-row">
                    <div class="kv-k">Email</div>
                    <div class="kv-v">${email}</div>
                  </div>
                  <div class="kv-row">
                    <div class="kv-k">Роль</div>
                    <div class="kv-v">admin</div>
                  </div>
                </div>
                <div class="note" style="margin-top: 16px; background: rgba(52, 211, 153, 0.1); border-color: rgba(52, 211, 153, 0.3); color: #34d399;">
                  ✓ Пользователь теперь имеет права администратора
                </div>
              `;
              resultSection.style.display = 'block';
              return;
            }
          } else if (updatedProfile) {
            successEl.textContent = `Роль администратора успешно установлена для ${email}`;
            successEl.style.display = 'block';
            
            resultContent.innerHTML = `
              <div class="kv">
                <div class="kv-row">
                  <div class="kv-k">Email</div>
                  <div class="kv-v">${email}</div>
                </div>
                <div class="kv-row">
                  <div class="kv-k">Username</div>
                  <div class="kv-v">${updatedProfile.username || '—'}</div>
                </div>
                <div class="kv-row">
                  <div class="kv-k">Роль</div>
                  <div class="kv-v">${updatedProfile.role}</div>
                </div>
              </div>
              <div class="note" style="margin-top: 16px; background: rgba(52, 211, 153, 0.1); border-color: rgba(52, 211, 153, 0.3); color: #34d399;">
                ✓ Пользователь теперь имеет права администратора
              </div>
            `;
            resultSection.style.display = 'block';
            return;
          }

          throw new Error('Не удалось проверить результат. Попробуйте проверить вручную через SQL Editor.');
        } catch (error) {
          console.error('Error setting admin role:', error);
          errorEl.textContent = error.message || 'Ошибка при установке роли администратора';
          errorEl.style.display = 'block';
        }
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

