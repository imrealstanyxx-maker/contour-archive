<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>КОНТУР — Первичная настройка администратора</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <header class="top">
    <div class="brand">
      <a class="back" href="index.html">← Архив</a>
      <div class="logo">КОНТУР</div>
      <div class="sub">Первичная настройка администратора</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panel-title">⚠️ КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ</div>
      <div class="panel-body">
        <div class="note" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); color: #ef4444; margin-bottom: 16px;">
          <strong>ЭТА СТРАНИЦА НЕБЕЗОПАСНА!</strong><br><br>
          Она позволяет установить роль администратора БЕЗ проверки прав.<br>
          <strong>Используйте ТОЛЬКО для первого администратора.</strong><br>
          После использования <strong>ОБЯЗАТЕЛЬНО УДАЛИТЕ</strong> файл <code>admin-setup-first.html</code> из проекта!
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-title">Установка первого администратора</div>
      <div class="panel-body">
        <div class="note" style="margin-bottom: 16px;">
          <strong>Инструкция:</strong><br>
          1. Сначала зарегистрируйте аккаунт на сайте (register.html)<br>
          2. Введите email зарегистрированного пользователя ниже<br>
          3. Нажмите кнопку для установки роли администратора<br>
          4. <strong>УДАЛИТЕ этот файл после использования!</strong>
        </div>

        <form id="admin-setup-form">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">Email пользователя</label>
            <input id="user-email" class="input" type="email" placeholder="observer@example.com" required />
            <div class="note" style="margin-top: 8px; font-size: 12px;">
              Email пользователя, которому нужно дать права администратора
            </div>
          </div>

          <div id="form-error" class="note" style="display: none; color: #ef4444; margin-bottom: 16px;"></div>
          <div id="form-success" class="note" style="display: none; color: #34d399; margin-bottom: 16px;"></div>

          <button type="submit" class="btn-link" style="width: 100%; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); color: #ef4444; font-weight: bold;">
            ⚠️ УСТАНОВИТЬ РОЛЬ АДМИНИСТРАТОРА
          </button>
        </form>
      </div>
    </section>

    <section class="panel" id="result-section" style="display: none;">
      <div class="panel-title">Результат</div>
      <div class="panel-body">
        <div id="result-content"></div>
      </div>
    </section>
  </main>

  <script src="assets/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function() {
      'use strict';
      
      let supabase = null;

      async function init() {
        if (!window.CONTOUR_CONFIG || window.CONTOUR_CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE') {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Supabase не настроен. Пожалуйста, настройте assets/config.js
            </div>
          `;
          return;
        }

        if (typeof window.supabase === 'undefined') {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Не удалось загрузить Supabase SDK
            </div>
          `;
          return;
        }

        supabase = window.supabase.createClient(
          window.CONTOUR_CONFIG.SUPABASE_URL,
          window.CONTOUR_CONFIG.SUPABASE_ANON_KEY
        );

        // Проверяем, что пользователь авторизован (но не проверяем роль - это для первого админа)
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          document.getElementById('admin-setup-form').innerHTML = `
            <div class="note" style="color: #ef4444;">
              Необходимо войти в систему. <a href="login.html?return=admin-setup-first.html" style="color: #5ac8fa;">Войти</a>
            </div>
          `;
          return;
        }
      }

      document.getElementById('admin-setup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const errorEl = document.getElementById('form-error');
        const successEl = document.getElementById('form-success');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
        resultSection.style.display = 'none';

        const email = document.getElementById('user-email').value.trim();

        try {
          // Находим пользователя через profiles с join к auth.users
          // Сначала получаем всех пользователей из profiles
          const { data: allProfiles, error: profilesError } = await supabase
            .from('profiles')
            .select('id, username, role');

          if (profilesError) {
            throw new Error('Не удалось загрузить список пользователей: ' + profilesError.message);
          }

          // Теперь нужно найти пользователя по email
          // Так как мы не можем напрямую запросить auth.users через anon key,
          // используем обходной путь: обновляем все профили, где username совпадает с частью email
          // ИЛИ используем функцию, которая работает через RLS

          // Лучший способ: использовать функцию Supabase или обновить через известный ID
          // Но проще всего - попросить пользователя ввести username или использовать SQL

          // Попробуем найти через известные данные
          // Если пользователь только что зарегистрировался, его профиль должен быть создан триггером
          
          // Обновляем профиль по email через функцию или напрямую, если знаем структуру
          // К сожалению, через anon key мы не можем напрямую получить email из auth.users
          
          // Альтернатива: используем username
          const usernameFromEmail = email.split('@')[0];
          
          // Пробуем найти по username (если он совпадает с частью email)
          const targetProfile = allProfiles.find(p => 
            p.username === usernameFromEmail || 
            p.username === email.split('@')[0]
          );

          if (!targetProfile) {
            // Если не нашли, пробуем обновить через функцию или даем инструкцию
            throw new Error(
              'Пользователь не найден. Убедитесь, что:\n' +
              '1. Пользователь зарегистрирован на сайте\n' +
              '2. Используйте SQL-скрипт из файла supabase/setup-admin-observer.sql\n' +
              'Или введите username вместо email (если он отличается от части email)'
            );
          }

          // Обновляем роль
          const { error: updateError } = await supabase
            .from('profiles')
            .update({ role: 'admin' })
            .eq('id', targetProfile.id);

          if (updateError) {
            // Если RLS блокирует, даем инструкцию по SQL
            if (updateError.code === '42501' || updateError.code === 'PGRST301') {
              throw new Error(
                'Недостаточно прав для обновления через веб-интерфейс.\n\n' +
                'Используйте SQL-скрипт в Supabase SQL Editor:\n\n' +
                'UPDATE public.profiles\n' +
                'SET role = \'admin\'\n' +
                'WHERE id = (\n' +
                '  SELECT id FROM auth.users WHERE email = \'' + email + '\'\n' +
                ');'
              );
            }
            throw updateError;
          }

          // Проверяем результат
          const { data: updatedProfile, error: checkError } = await supabase
            .from('profiles')
            .select('username, role')
            .eq('id', targetProfile.id)
            .single();

          if (checkError) throw checkError;

          successEl.textContent = `Роль администратора успешно установлена!`;
          successEl.style.display = 'block';
          
          resultContent.innerHTML = `
            <div class="kv">
              <div class="kv-row">
                <div class="kv-k">Email</div>
                <div class="kv-v">${email}</div>
              </div>
              <div class="kv-row">
                <div class="kv-k">Username</div>
                <div class="kv-v">${updatedProfile.username || '—'}</div>
              </div>
              <div class="kv-row">
                <div class="kv-k">Роль</div>
                <div class="kv-v">${updatedProfile.role}</div>
              </div>
            </div>
            <div class="note" style="margin-top: 16px; background: rgba(52, 211, 153, 0.1); border-color: rgba(52, 211, 153, 0.3); color: #34d399;">
              ✓ Пользователь теперь имеет права администратора
            </div>
            <div class="note" style="margin-top: 16px; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
              <strong>⚠️ ВАЖНО:</strong> Удалите файл admin-setup-first.html из проекта для безопасности!
            </div>
          `;
          resultSection.style.display = 'block';
        } catch (error) {
          console.error('Error setting admin role:', error);
          const errorMessage = error.message || 'Ошибка при установке роли администратора';
          errorEl.innerHTML = errorMessage.replace(/\n/g, '<br>');
          errorEl.style.display = 'block';
        }
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

